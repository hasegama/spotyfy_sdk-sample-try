# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to Firebase Hosting on merge
'on':
  push:
    branches:
      - main
jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      # -- ここから追記部分！ -- #
      # Flutter のインストール clone がはやい
      - name: Install Flutter
        run: git clone https://github.com/flutter/flutter.git

      # PATH を通す
      - name: Add path
        run: echo "$(pwd)/flutter/bin" >> $GITHUB_PATH

      # betaチャンネルに変更
      - name: Change channel
        run: |
          flutter channel beta
          flutter upgrade

      # spotify-sdkのインストール
      # - name: Install spotify-sdk
      #   run: flutter pub add spotify_sdk
      '''
      Run flutter pub add spotify_sdk
        flutter pub add spotify_sdk
        shell: /usr/bin/bash -e ***0***
      Downloading package sky_engine...                                  376ms
      Downloading flutter_patched_sdk tools...                           512ms
      Downloading flutter_patched_sdk_product tools...                   300ms
      Downloading linux-x64 tools...                                   1,246ms
      Downloading linux-x64/font-subset tools...                         189ms
      "spotify_sdk" is already in "dependencies". Use "pub upgrade spotify_sdk" to upgrade to a later version!
        pub finished with exit code 65
      Error: Process completed with exit code 65.
      '''

      # パッケージのダウンロード
      - name: Download Flutter packages
        run: flutter pub get

        # -- ここまで追記部分！ -- #
        # 解説:
        #   ようは flutter build web をたたいても flutterがインストールされていないので動かないということ
        #   インストールしてPATH通してパッケージダウンロードしているだけ。

      - run: flutter build web
      - uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_SPOTIFY_SDK_SAMPLE_TRY }}'
          channelId: live
          projectId: spotify-sdk-sample-try
        env:
          FIREBASE_CLI_PREVIEWS: hostingchannels
